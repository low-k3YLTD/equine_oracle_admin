import { describe, it, expect, beforeEach, vi } from "vitest";\nimport { appRouter } from "./routers";\nimport { COOKIE_NAME } from "@shared/const";\nimport type { TrpcContext } from "./_core/context\";\n\ntype AuthenticatedUser = NonNullable<TrpcContext[\"user\"]>;\n\nfunction createAuthContext(userId: number = 1): { ctx: TrpcContext; clearedCookies: any[] } {\n  const clearedCookies: any[] = [];\n\n  const user: AuthenticatedUser = {\n    id: userId,\n    openId: `user-${userId}`,\n    email: `user${userId}@example.com`,\n    name: `Test User ${userId}`,\n    loginMethod: \"test\",\n    role: \"user\",\n    createdAt: new Date(),\n    updatedAt: new Date(),\n    lastSignedIn: new Date(),\n  };\n\n  const ctx: TrpcContext = {\n    user,\n    req: {\n      protocol: \"https\",\n      headers: {},\n    } as TrpcContext[\"req\"],\n    res: {\n      clearCookie: (name: string, options: any) => {\n        clearedCookies.push({ name, options });\n      },\n    } as TrpcContext[\"res\"],\n  };\n\n  return { ctx, clearedCookies };\n}\n\ndescribe(\"appRouter\", () => {\n  describe(\"auth\", () => {\n    it(\"should return current user with me query\", async () => {\n      const { ctx } = createAuthContext();\n      const caller = appRouter.createCaller(ctx);\n      const user = await caller.auth.me();\n      expect(user).toBeDefined();\n      expect(user?.id).toBe(1);\n      expect(user?.openId).toBe(\"user-1\");\n    });\n\n    it(\"should clear session cookie on logout\", async () => {\n      const { ctx, clearedCookies } = createAuthContext();\n      const caller = appRouter.createCaller(ctx);\n      const result = await caller.auth.logout();\n      expect(result.success).toBe(true);\n      expect(clearedCookies).toHaveLength(1);\n      expect(clearedCookies[0]?.name).toBe(COOKIE_NAME);\n    });\n  });\n\n  describe(\"predictions\", () => {\n    it(\"should validate prediction input\", async () => {\n      const { ctx } = createAuthContext();\n      const caller = appRouter.createCaller(ctx);\n\n      // Missing required fields should fail\n      await expect(\n        caller.predictions.create({\n          horseName: \"Test Horse\",\n          // Missing required fields\n        } as any)\n      ).rejects.toThrow();\n    });\n\n    it(\"should list predictions for a user\", async () => {\n      const { ctx } = createAuthContext();\n      const caller = appRouter.createCaller(ctx);\n      const predictions = await caller.predictions.list({ limit: 50 });\n      expect(Array.isArray(predictions)).toBe(true);\n    });\n\n    it(\"should get prediction analytics\", async () => {\n      const { ctx } = createAuthContext();\n      const caller = appRouter.createCaller(ctx);\n      const analytics = await caller.predictions.analytics();\n      expect(analytics).toBeDefined();\n      expect(analytics?.totalPredictions).toBeGreaterThanOrEqual(0);\n      expect(analytics?.averageEnsembleScore).toBeGreaterThanOrEqual(0);\n    });\n\n    it(\"should export predictions as CSV\", async () => {\n      const { ctx } = createAuthContext();\n      const caller = appRouter.createCaller(ctx);\n      const result = await caller.predictions.export();\n      expect(result).toBeDefined();\n      expect(result?.filename).toMatch(/^predictions-/);\n      expect(typeof result?.csv).toBe(\"string\");\n    });\n\n    it(\"should filter predictions\", async () => {\n      const { ctx } = createAuthContext();\n      const caller = appRouter.createCaller(ctx);\n      const predictions = await caller.predictions.filtered({\n        track: \"Ellerslie\",\n        limit: 10,\n      });\n      expect(Array.isArray(predictions)).toBe(true);\n    });\n  });\n\n  describe(\"subscriptions\", () => {\n    it(\"should get current subscription\", async () => {\n      const { ctx } = createAuthContext();\n      const caller = appRouter.createCaller(ctx);\n      const subscription = await caller.subscriptions.getCurrent();\n      // May be undefined if no subscription exists\n      expect(subscription === undefined || subscription?.tierName).toBeTruthy();\n    });\n\n    it(\"should get rate limit info\", async () => {\n      const { ctx } = createAuthContext();\n      const caller = appRouter.createCaller(ctx);\n      const rateLimit = await caller.subscriptions.rateLimit();\n      expect(rateLimit).toBeDefined();\n      expect(rateLimit?.tier).toBeDefined();\n      expect(rateLimit?.dailyLimit).toBeGreaterThan(0);\n      expect(rateLimit?.remainingToday).toBeGreaterThanOrEqual(0);\n    });\n  });\n\n  describe(\"analytics\", () => {\n    it(\"should get analytics dashboard\", async () => {\n      const { ctx } = createAuthContext();\n      const caller = appRouter.createCaller(ctx);\n      const dashboard = await caller.analytics.dashboard();\n      expect(dashboard).toBeDefined();\n      expect(dashboard?.totalPredictions).toBeGreaterThanOrEqual(0);\n    });\n  });\n});\n
